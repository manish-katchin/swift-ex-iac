AWSTemplateFormatVersion: "2010-09-09"
Description: The EnginesService ECS Service

Parameters:
  EnvironmentName:
    Type: String
    Default: swiftx
  
  ComponentName:
    Type: String
    Default: swiftx
  
  PartName:
    Type: String
    Default: engines
  
  PrivateSubnetIds:
    Type: CommaDelimitedList
  EnginesServicePort:
    Description: EnginesService Service Port
    Type: String
    Default: 3000


  EnginesServiceSecurityGroupId:
    Description: The EnginesService security group ID
    Type: String
  EnginesServiceExecutionRoleArn:
    Description: The ARN to EnginesService IAC execution role
    Type: String
  EnginesServiceTaskRoleArn:
    Description: The ARN to EnginesService IAC task role
    Type: String
  EnginesServiceCluster:
    Description: Engines service cluster ID.
    Type: String
  ServiceImageTag:
    Type: String
    Default: latest
  ForceNewDeployment:
    Description: Force a new deployment of the ECS service
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]
  IsItFirstSetup:
    Description: Boolean parameter to setup desired count
    Type: String
    Default: false
    # for autoscaling
  MinContainers:
    Type: Number
    Default: 2
  # for autoscaling
  MaxContainers:
    Type: Number
    Default: 10
  # target CPU utilization (%)
  AutoScalingTargetValue:
    Type: Number
    Default: 75

Conditions:
  ZeroDesiredCount: !Equals [!Ref IsItFirstSetup, "true"]
  NonZeroDesiredCount: !Equals [!Ref IsItFirstSetup, "false"]
  CreateProdResources:
    !Or
      - !Equals [!Ref EnvironmentName, "prod"]
      - !Equals [!Ref EnvironmentName, "prod2"]
      - !Equals [!Ref EnvironmentName, "dr"]

Resources:
  CloudWatchLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Join:
          - "-"
          - - !Ref EnvironmentName
            - !Ref ComponentName
            - !Ref PartName
            - "common-log-group"
      RetentionInDays: 365
      Tags:
        - Key: STAGE
          Value: !Ref EnvironmentName
        - Key: COMPONENT_NAME
          Value: !Ref ComponentName
        - Key: PART_NAME
          Value: !Ref PartName
        - Key: service
          Value: !Join ["-", [!Ref ComponentName, !Ref PartName]]
        - Key: StackID
          Value: !Ref "AWS::StackId"


  EnginesServiceTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      NetworkMode: awsvpc
      Family:
        Fn::Join:
          - "-"
          - - !Ref EnvironmentName
            - !Ref ComponentName
            - !Ref PartName
            - "task-definition"
      Cpu: !If [CreateProdResources, 1024, 1024]
      Memory: !If [CreateProdResources, 2048, 2048]
      RuntimePlatform:
        CpuArchitecture: X86_64
        OperatingSystemFamily: LINUX
      RequiresCompatibilities:
        - FARGATE
      ContainerDefinitions:
        - Name: !Sub "component-${ComponentName}-${PartName}-service-container"
          Image: !Sub
            - ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ECRRepositoryName}:${ServiceImageTag}
            - ECRRepositoryName:
                Fn::Join:
                  - "-"
                  - - !Ref EnvironmentName
                    - !Ref ComponentName
                    - !Ref PartName
                    - "ecr"
          Essential: true
          PortMappings:
            - containerPort: !Ref EnginesServicePort
              hostPort: !Ref EnginesServicePort
              protocol: tcp
          Environment:
            - Name: NODE_ENV
              Value: !Ref EnvironmentName
            - Name: PORT
              Value: !Ref EnginesServicePort
            - Name: AWS_REGION
              Value: !Ref AWS::Region
          Secrets:
            - Name: MONGODB_CONN_STRING
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/mongodb_conn_string"
            - Name: DB_NAME
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/db_name"
            - Name: PASSWORD_SALT_ROUNDS
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/password_salt_rounds"
            - Name: JWT_SECRET
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/jwt_secret"
            - Name: GMAIL_CLIENT_ID
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/gmail_client_id"
            - Name: GMAIL_CLIENT_SECRET
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/gmail_client_secret"
            - Name: GMAIL_ACCESS_TOKEN
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/gmail_access_token"
            - Name: GMAIL_REFRESH_TOKEN
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/gmail_refresh_token"
            - Name: GMAIL_REDIRECT_URI
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/gmail_redirect_uri"
            - Name: ALCHEMY_PAY_QUOTE_REQUEST_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_quote_request_url"
            - Name: ALCHEMY_PAY_REGISTER_USER_REQUEST_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_register_user_request_url"
            - Name: ALCHEMY_PAY_USER_KYC_STATUS_REQUEST_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_user_kyc_status_request_url"
            - Name: ALCHEMY_PAY_ORDER_CREATION_REQUEST_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_order_creation_request_url"
            - Name: ALCHEMY_PAY_USER_AUTH_TOKEN_REQUEST_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_user_auth_token_request_url"
            - Name: ALCHEMY_PAY_USER_SELL_ORDER_REQUEST_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_user_sell_order_request_url"
            - Name: ALCHEMY_PAY_USER_SELL_ORDER_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_user_sell_order_url"
            - Name: ALCHEMY_PAY_SELL_REDIRECT
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_sell_redirect"
            - Name: ALCHEMY_PAY_SELL_WEBHOOK
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_sell_webhook"
            - Name: ALCHEMY_PAY_REDIRECT_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_redirect_url"
            - Name: ALCHEMY_PAY_WEBHOOK_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_webhook_url"
            - Name: ALCHEMY_PAY_SECRET
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_secret"
            - Name: ALCHEMY_PAY_APPID
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_appid"
            - Name: ALCHEMY_PAY_MERCHANT_NO
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_merchant_no"
            - Name: ALCHEMY_PAY_ACCOUNT_ID
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_pay_account_id"
            - Name: ALCHEMY_PROVIDER_WEBSOCKET
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/alchemy_provider_websocket"
            - Name: STELLAR_USDC_ADDRESS
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/stellar_usdc_address"
            - Name: STELLAR_ONE_TAP_KEY
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/stellar_one_tap_key"
            - Name: ACTIVATE_STELLAR_ADDRESS
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/activate_stellar_address"
            - Name: RPC_STELLAR
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/rpc_stellar"
            - Name: STELLAR_USDC_TRUST_LIMIT
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/stellar_usdc_trust_limit"
            - Name: STELLAR_AMOUNT
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/stellar_amount"
            - Name: MORALIS_API_KEY
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/moralis_api_key"
            - Name: SOROBAN_HOOKS_API_KEY
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/soroban_hooks_api_key"
            - Name: SOROBAN_HOOKS_API_TYPE
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/soroban_hooks_api_type"
            - Name: SOROBON_NOTIFICATION_WEBHOOK
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/sorobon_notification_webhook"
            - Name: MORALIS_NOTIFICATION_WEBHOOK
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/moralis_notification_webhook"
            - Name: NOTIFICATION_ENCRYPT_KEY
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/notification_encrypt_key"
            - Name: SOROBON_WALLET_WATCH_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/sorobon_wallet_watch_url"
            - Name: ETH_SMART_CONTRACT
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/eth_smart_contract"
            - Name: ETH_PROVIDER
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/eth_provider"
            - Name: COIN_GECKO_API_URL
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/coin_gecko_api_url"
            - Name: ERC20_TRANSFER_TOPIC
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/erc20_transfer_topic"
            - Name: ERC20_APPROVAL_TOPIC
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/erc20_approval_topic"
            - Name: ACTIVATE_WALLET_TIMEOUT
              ValueFrom: !Sub "/${EnvironmentName}/${ComponentName}/${PartName}/activate_wallet_timeout"
          # ReadonlyRootFilesystem: true  # Commented out for nginx compatibility
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref AWS::Region
              awslogs-group: !Ref CloudWatchLogsGroup
              awslogs-stream-prefix: !Join ["-", [!Ref ComponentName, !Ref PartName]]

      ExecutionRoleArn: !Ref EnginesServiceExecutionRoleArn
      TaskRoleArn: !Ref EnginesServiceTaskRoleArn
      Tags:
        - Key: STAGE
          Value: !Ref EnvironmentName
        - Key: COMPONENT_NAME
          Value: !Ref ComponentName
        - Key: PART_NAME
          Value: !Ref PartName
        - Key: service
          Value: !Join ["-", [!Ref ComponentName, !Ref PartName]]
        - Key: StackID
          Value: !Ref "AWS::StackId"
  EnginesServiceEcsService:
    Type: AWS::ECS::Service
    Properties:
      LaunchType: FARGATE
      ServiceName:
        Fn::Join:
          - "-"
          - - !Ref EnvironmentName
            - !Ref ComponentName
            - !Ref PartName
            - "ecs-service"
      Cluster: !Ref EnginesServiceCluster
      TaskDefinition: !Ref EnginesServiceTaskDefinition
      DesiredCount: !If [ZeroDesiredCount, 0, !If [CreateProdResources, 2, 1]]
      LoadBalancers:
        - ContainerName: !Sub "component-${ComponentName}-${PartName}-service-container"
          ContainerPort: !Ref EnginesServicePort
          TargetGroupArn:
            Fn::ImportValue:
              Fn::Sub:
                - "${EnginesServiceNetworkStackName}-EnginesServiceServiceTargetGroup"
                - EnginesServiceNetworkStackName:
                    Fn::Join:
                      - "-"
                      - - !Ref EnvironmentName
                        - !Ref ComponentName
                        - !Ref PartName
                        - "iac-network"
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !Ref EnginesServiceSecurityGroupId
          Subnets: !Ref PrivateSubnetIds
      PropagateTags: TASK_DEFINITION
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: false
          Rollback: false
      # ForceNewDeployment: !Equals 
      #   - !Ref ForceNewDeployment
      #   - "true"
      Tags:
        - Key: STAGE
          Value: !Ref EnvironmentName
        - Key: COMPONENT_NAME
          Value: !Ref ComponentName
        - Key: PART_NAME
          Value: !Ref PartName
        - Key: service
          Value: !Join ["-", [!Ref ComponentName, !Ref PartName]]
        - Key: StackID
          Value: !Ref "AWS::StackId"
  AutoScalingRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Join:
          - "-"
          - - !Ref EnvironmentName
            - !Ref ComponentName
            - !Ref PartName
            - "autoscaling-role"
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceAutoscaleRole"
      Tags:
        - Key: "STAGE"
          Value: !Ref EnvironmentName
        - Key: "COMPONENT_NAME"
          Value: !Ref ComponentName
        - Key: "PART_NAME"
          Value: !Ref PartName
        - Key: service
          Value: !Join ["-", [!Ref ComponentName, !Ref PartName]]
        - Key: StackID
          Value: !Ref "AWS::StackId"
  AutoScalingTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Condition: NonZeroDesiredCount
    Properties:
      MinCapacity: !If [CreateProdResources, !Ref MinContainers, 1]
      MaxCapacity: !Ref MaxContainers
      ResourceId:
        Fn::Join:
          - "/"
          - - "service"
            - !Ref EnginesServiceCluster
            - !GetAtt EnginesServiceEcsService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      # "The Amazon Resource Name (ARN) of an AWS Identity and Access Management (IAM) role that allows Application Auto Scaling to modify your scalable target."
      RoleARN: !GetAtt AutoScalingRole.Arn
  AutoScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Condition: NonZeroDesiredCount
    Properties:
      PolicyName:
        Fn::Join:
          - "-"
          - - !Ref EnvironmentName
            - !Ref ComponentName
            - !Ref PartName
            - "autoscaling-policy"
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref AutoScalingTarget
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: 10
        ScaleOutCooldown: 10
        # Keep things at or lower than 50% CPU utilization, for example
        TargetValue: !Ref AutoScalingTargetValue

Outputs:
  AutoScalingRoleArn:
    Description: AutoScaling role for tms2 dd service
    Value: !GetAtt AutoScalingRole.Arn

